(global["webpackJsonp"]=global["webpackJsonp"]||[]).push([["pages/index/index"],{1740:function(e,t,n){"use strict";var i=n("a575"),o=n.n(i);o.a},"2e6b":function(e,t,n){"use strict";var i,o=function(){var e=this,t=e.$createElement;e._self._c},c=[];n.d(t,"b",(function(){return o})),n.d(t,"c",(function(){return c})),n.d(t,"a",(function(){return i}))},4137:function(e,t,n){"use strict";n.r(t);var i=n("2e6b"),o=n("c6ba");for(var c in o)"default"!==c&&function(e){n.d(t,e,(function(){return o[e]}))}(c);n("1740");var a,r=n("f0c5"),s=Object(r["a"])(o["default"],i["b"],i["c"],!1,null,null,null,!1,i["a"],a);t["default"]=s.exports},"6ba1":function(e,t,n){"use strict";var i,o=function(){var e=this,t=e.$createElement;e._self._c},c=[];n.d(t,"b",(function(){return o})),n.d(t,"c",(function(){return c})),n.d(t,"a",(function(){return i}))},"7ebd":function(e,t,n){"use strict";var i=n("9afc"),o=n.n(i);o.a},"8d47":function(e,t,n){"use strict";n.r(t);var i=n("6ba1"),o=n("be31");for(var c in o)"default"!==c&&function(e){n.d(t,e,(function(){return o[e]}))}(c);n("7ebd");var a,r=n("f0c5"),s=Object(r["a"])(o["default"],i["b"],i["c"],!1,null,null,null,!1,i["a"],a);t["default"]=s.exports},"9afc":function(e,t,n){},a575:function(e,t,n){},be31:function(e,t,n){"use strict";n.r(t);var i=n("facf"),o=n.n(i);for(var c in i)"default"!==c&&function(e){n.d(t,e,(function(){return i[e]}))}(c);t["default"]=o.a},c6ba:function(e,t,n){"use strict";n.r(t);var i=n("c96d"),o=n.n(i);for(var c in i)"default"!==c&&function(e){n.d(t,e,(function(){return i[e]}))}(c);t["default"]=o.a},c96d:function(e,t,n){"use strict";(function(e){Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var i=n("2f62"),o=s(n("542c")),c=s(n("f6ad")),a=s(n("5e0f")),r=s(n("8d47"));function s(e){return e&&e.__esModule?e:{default:e}}function u(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function l(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?u(Object(n),!0).forEach((function(t){d(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):u(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function d(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var f=function(){n.e("pages/index/components/device-item").then(function(){return resolve(n("c91d"))}.bind(null,n)).catch(n.oe)},v=function(){n.e("pages/index/components/device-curtain-setting").then(function(){return resolve(n("dbb8"))}.bind(null,n)).catch(n.oe)},h=function(){n.e("pages/index/components/device-air-conditioner-setting").then(function(){return resolve(n("240d"))}.bind(null,n)).catch(n.oe)},p=function(){n.e("pages/index/components/device-air-purifier-setting").then(function(){return resolve(n("24df"))}.bind(null,n)).catch(n.oe)},g={data:function(){return{statusBarHeight:20,navigationBarHeight:64,bottomArea:6,loginTip:"当前未登录",gridColumn:2,roomNameValues:[],currentRoomValue:null,roomZones:[],isWebSocketOpen:!1,isRequestSpacesDone:!1,currentDeviceDataModel:null,showPop:!1,deviceType:{isDimmer:!1,isCurtain:!1,isAirConditioner:!1,isAirPurification:!1}}},components:{DeviceItem:f,DeviceDimmerSetting:r.default,DeviceCurtainSetting:v,DeviceAirConditionerSetting:h,DeviceAirPurifierSetting:p},onLoad:function(){var t=this;this.statusBarHeight=getApp().globalData.statusBarHeight,this.navigationBarHeight=getApp().globalData.navigationBarHeight,this.bottomArea=getApp().globalData.bottomArea>0?getApp().globalData.bottomArea:6,e.$on("haveLogin",(function(){t.requestAccessibleSpaces()})),this.isLogin&&(console.log(this.isLogin),this.requestAccessibleSpaces()),e.onSocketOpen((function(){t.isWebSocketOpen=!0,console.log("WebSocket连接已打开！");var n={data:{token:e.getStorageSync("token")},timestamp:Date.now()};e.sendSocketMessage({data:JSON.stringify(n)})})),e.onSocketError((function(){console.log("WebSocket连接打开失败！")})),e.onSocketMessage((function(e){t.handleSocketMeesage(e.data)})),e.onSocketClose((function(e){t.isWebSocketOpen=!1,console.log("WebSocket 已关闭！",e),1006===e.code&&t.connectSocket()}))},onShow:function(){this.isLogin&&this.currentRoomValue&&this.connectSocket()},onHide:function(){e.closeSocket()},computed:l({},(0,i.mapState)(["isLogin"]),{popDeviceImage:function(){if(this.currentDeviceDataModel)switch(this.currentDeviceDataModel.device.typeC){case"dimmingcontrol":return"../../static/images/stey_ioticon_editceilinglamp.png";case"curtaincontrol":return"../../static/images/stey_ioticon_editcurtain.png";case"airconditionercontrol":return"../../static/images/stey_ioticon_editairconditioner.png";case"airpurifiercontrol":return"../../static/images/stey_ioticon_editairquality.png"}return""},showSwitchImage:function(){return!!this.currentDeviceDataModel&&"curtaincontrol"!==this.currentDeviceDataModel.device.typeC},switchImage:function(){return this.currentDeviceDataModel?this.currentDeviceDataModel.isDeviceOn?"../../static/images/stey_ioticon_switch_on.png":"../../static/images/stey_ioticon_switch_off.png":""},deviceName:function(){return this.currentDeviceDataModel?this.currentDeviceDataModel.device.deviceName:""},switchState:function(){return this.currentDeviceDataModel?this.currentDeviceDataModel.isDeviceOn?"已打开":"已关闭":""}}),methods:l({},(0,i.mapMutations)(["logout"]),{loginButtonClick:function(){e.navigateTo({url:"../login/login"})},bookingButtonClick:function(){var t=encodeURIComponent("https://www.stey.com/zh-CN/booking/list");e.navigateTo({url:"../web/web-view?url=".concat(t)})},tapCurrentRoom:function(e){this.currentRoomValue=e.detail,this.requestIoTTemplate()},requestAccessibleSpaces:function(){var t=this;e.request({url:"https://gateway.stey.com/iot-service/app/iot/accessible-spaces",method:"GET",data:{},header:{"Content-Type":"application/json; charset=utf-8",Authorization:"Bearer ".concat(e.getStorageSync("token")),"Accept-Language":"zh"},success:function(n){if(console.log(n),200==n.statusCode)t.handleAccessibleSpaces(n.data.data);else if(401==n.statusCode)console.log("token失效"),t.logout(),t.loginTip="登录失效";else{var i=n.data.error;i&&e.showToast({icon:"none",title:i,duration:2e3})}},fail:function(){e.showToast({icon:"none",title:"网络请求失败",duration:2e3})},complete:function(){t.isRequestSpacesDone=!0}})},handleAccessibleSpaces:function(e){var t=e.map((function(e){return new o.default(e)}));t.length>0?(this.currentRoomValue=t[0].spaceId,this.roomNameValues=t.map((function(e){var t={text:e.roomName,value:e.spaceId};return t})),this.requestIoTTemplate()):(this.currentRoomValue=138,this.roomNameValues=[{text:"520",value:138},{text:"521",value:142}],this.requestIoTTemplate())},requestIoTTemplate:function(){var t=this;this.currentRoomValue&&(e.showLoading({title:"",mask:!0}),e.request({url:"https://gateway.stey.com/iot-service/staff-app/iot/template/".concat(this.currentRoomValue),method:"GET",data:{},header:{"Content-Type":"application/json; charset=utf-8",Authorization:"Bearer ".concat(e.getStorageSync("token")),"Accept-Language":"zh"},success:function(n){if(console.log(n),200==n.statusCode)t.handleTemplate(n.data.data.zones);else if(401==n.statusCode)console.log("token失效"),t.logout(),t.loginTip="登录失效";else{var i=n.data.error;i&&e.showToast({icon:"none",title:i,duration:2e3})}},fail:function(){e.showToast({icon:"none",title:"网络请求失败",duration:2e3})},complete:function(){e.hideLoading()}}))},handleTemplate:function(e){var t=e.map((function(e){return new c.default(e)})).filter((function(e){return!e.isSystemZone}));this.roomZones=t,this.connectSocket()},connectSocket:function(){this.isWebSocketOpen&&e.closeSocket(),e.connectSocket({url:"wss://gateway.stey.com/iot-service/app/iot/connect/".concat(this.currentRoomValue)})},handleSocketMeesage:function(e){var t=this,n=JSON.parse(e),i=new a.default(n);this.roomZones.forEach((function(e){var n=e.deviceDataModels.filter((function(e){return e.device.zoneDeviceId===i.zoneDeviceId}))[0];if(n){var o=n.device,c=o.controls.filter((function(e){return e.zoneDeviceControlId===i.zoneDeviceControlId}))[0];c&&(c.value=i.value,n.setDevice(o),t.currentDeviceDataModel&&t.currentDeviceDataModel.device.zoneDeviceId===o.zoneDeviceId&&(t.currentDeviceDataModel=n))}}))},deviceSettingClick:function(e){this.currentDeviceDataModel=e,this.deviceType.isDimmer="dimmingcontrol"===e.device.typeC,this.deviceType.isCurtain="curtaincontrol"===e.device.typeC,this.deviceType.isAirConditioner="airconditionercontrol"===e.device.typeC,this.deviceType.isAirPurification="airpurifiercontrol"===e.device.typeC,this.showPop=!0},switchButtonClick:function(){var e=this,t=this.deviceControlModel(10).zoneDeviceControlId;"airpurifiercontrol"===this.currentDeviceDataModel.device.typeC&&1===this.currentDeviceDataModel.device.version&&(t=this.deviceControlModel(40).zoneDeviceControlId);var n={spaceId:this.currentRoomValue,value:this.currentDeviceDataModel.isDeviceOn?"false":"true",zoneDeviceId:this.currentDeviceDataModel.device.zoneDeviceId,zoneDeviceControlId:t};this.sendSocket(n).then((function(t){e.currentDeviceDataModel.isDeviceOn=!e.currentDeviceDataModel.isDeviceOn}))},popUpClose:function(){this.showPop=!1},sendSocketObj:function(e){var t=l({spaceId:this.currentRoomValue},e);this.sendSocket(t)},sendSocket:function(t){var n=this;return console.log(t),new Promise((function(i,o){e.vibrateShort(),e.showLoading({title:"发送中",mask:!0}),e.request({url:"https://gateway.stey.com/iot-service/staff-app/iot/run-command",method:"POST",data:{data:t,timestamp:Date.now()},header:{"Content-Type":"application/json; charset=utf-8",Authorization:"Bearer ".concat(e.getStorageSync("token")),"Accept-Language":"zh"},success:function(t){if(200==t.statusCode)i(t);else if(401==t.statusCode)console.log("token失效"),n.logout(),n.loginTip="登录失效";else{var o=t.data.error;o&&e.showToast({icon:"none",title:o,duration:2e3})}},fail:function(){e.showToast({icon:"none",title:"网络请求失败",duration:2e3})},complete:function(){e.hideLoading()}})}))},deviceControlModel:function(e){var t=this.currentDeviceDataModel.device.controls.filter((function(t){return t.tag==e}))[0];return t||new DeviceControlModel}})};t.default=g}).call(this,n("543d")["default"])},e843:function(e,t,n){"use strict";(function(e){n("9155");i(n("66fd"));var t=i(n("4137"));function i(e){return e&&e.__esModule?e:{default:e}}e(t.default)}).call(this,n("543d")["createPage"])},facf:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;i(n("3f5a")),i(n("0ba6"));function i(e){return e&&e.__esModule?e:{default:e}}var o={data:function(){return{sliderValue:0,isDrag:!1,isWatchDataChange:!1}},props:{deviceDataModel:null},watch:{deviceDataModel:function(e,t){this.isWatchDataChange=!0,this.sliderValue=e.sliderValue}},mounted:function(){this.deviceDataModel&&(this.sliderValue=this.deviceDataModel.sliderValue)},methods:{sliderValueChange:function(e){this.sliderValue=e.detail,this.isDrag||this.isWatchDataChange||this.sliderDragEnd()},sliderDragStart:function(){this.isDrag=!0},sliderDragEnd:function(){if(this.isDrag=!1,this.isWatchDataChange=!1,this.deviceDataModel.isDeviceOn){var e=this.deviceControlModel(20).zoneDeviceControlId,t={value:"".concat(this.sliderValue),zoneDeviceId:this.deviceDataModel.device.zoneDeviceId,zoneDeviceControlId:e};this.$emit("sendsocketobj",t)}},deviceControlModel:function(e){var t=this.deviceDataModel.device.controls.filter((function(t){return t.tag==e}))[0];return t||null}}};t.default=o}},[["e843","common/runtime","common/vendor"]]]);